<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Discovery - Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="dashboard-page">
            <div class="header">
                <div class="user-info">
                    <div class="logo-small">üéµ</div>
                    <div>
                        <h2 id="userName">Welcome!</h2>
                        <button onclick="logout()" class="btn-text">Logout</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <h1>Discover New Music</h1>
                <p class="subtitle">Add fresh tracks to your playlist automatically</p>

                <div class="form-card">
                    <div class="form-group">
                        <label for="playlistSelect">Select Playlist</label>
                        <select id="playlistSelect" class="input">
                            <option value="">Loading playlists...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxSongs">Number of Songs (1-50)</label>
                        <input type="number" id="maxSongs" class="input" min="1" max="50" value="10">
                    </div>

                    <div class="form-group">
                        <label for="lastfmUsername">Last.fm Username (Optional)</label>
                        <input type="text" id="lastfmUsername" class="input" placeholder="Your Last.fm username">
                    </div>

                    <button onclick="startDiscovery()" id="startBtn" class="btn-primary">
                        Start Discovery
                    </button>
                </div>

                <div id="progressSection" class="progress-section hidden">
                    <h3>Discovery in Progress...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="statusMessage" class="status-message">Starting...</p>
                    <div id="resultDetails" class="result-details hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use localhost for local testing, Railway for production
        // Backend API URL - using Railway-provided domain
        const API_URL = 'https://user-playlist-generator-production.up.railway.app';

        console.log('Using API URL:', API_URL);
        let currentJobId = null;
        let statusCheckInterval = null;
        let accessToken = null;

        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üéØ DASHBOARD LOADED');
            console.log('üìç Current URL:', window.location.href);

            try {
                // Check for token in localStorage
                const tokenInfo = localStorage.getItem('spotify_token_info');
                console.log('üíæ Token from localStorage:', tokenInfo ? 'EXISTS' : 'NULL');

                if (!tokenInfo) {
                    console.log('‚ùå No token found, redirecting to login');
                    window.location.href = '/user-playlist-generator/login.html';
                    return;
                }

                const token = JSON.parse(tokenInfo);
                accessToken = token.access_token;
                console.log('üîë Access token parsed:', accessToken ? accessToken.substring(0, 20) + '...' : 'NULL');

                // Check if token is expired
                const now = Date.now() / 1000;
                console.log('‚è∞ Token expires at:', token.expires_at, '| Current time:', now);

                if (token.expires_at && now > token.expires_at) {
                    console.log('‚ùå Token expired, redirecting to login');
                    localStorage.removeItem('spotify_token_info');
                    window.location.href = '/user-playlist-generator/login.html';
                    return;
                }

                console.log('‚úÖ Token found and valid, loading user info from Spotify...');

                // Fetch user info from Spotify API
                const userResponse = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                console.log('üë§ User info response status:', userResponse.status);

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    console.log('‚úÖ User info loaded:', userData.display_name);
                    document.getElementById('userName').textContent = `Welcome, ${userData.display_name}!`;
                    loadPlaylists();
                } else {
                    console.error('‚ùå Failed to fetch user info, status:', userResponse.status);
                    const errorText = await userResponse.text();
                    console.error('‚ùå Error response:', errorText);
                    localStorage.removeItem('spotify_token_info');
                    window.location.href = '/user-playlist-generator/login.html';
                }
            } catch (error) {
                console.error('‚ùå Auth check error:', error);
                console.error('‚ùå Error stack:', error.stack);
                localStorage.removeItem('spotify_token_info');
                window.location.href = '/user-playlist-generator/login.html';
            }
        });

        async function logout() {
            // Clear token from localStorage
            localStorage.removeItem('spotify_token_info');

            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            console.log('‚úÖ Logged out');
            window.location.href = '/user-playlist-generator/login.html';
        }

        async function loadPlaylists() {
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Loading playlists...</option>';

            try {
                // Fetch playlists from Spotify API directly using token
                const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load playlists');
                }

                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    select.innerHTML = '<option value="">Select a playlist...</option>';

                    data.items.forEach(playlist => {
                        const option = document.createElement('option');
                        option.value = playlist.id;
                        option.textContent = `${playlist.name} (${playlist.tracks.total} tracks)${playlist.owner.id === playlist.owner.id ? '' : ' - Collaborative'}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No playlists found</option>';
                }
            } catch (error) {
                console.error('Error loading playlists:', error);
                select.innerHTML = '<option value="">Error loading playlists</option>';
            }
        }

        async function startDiscovery() {
            const playlistId = document.getElementById('playlistSelect').value;
            const maxSongs = parseInt(document.getElementById('maxSongs').value);
            const lastfmUsername = document.getElementById('lastfmUsername').value.trim();

            if (!playlistId) {
                alert('Please select a playlist');
                return;
            }

            if (maxSongs < 1 || maxSongs > 50) {
                alert('Number of songs must be between 1 and 50');
                return;
            }

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';

            const progressSection = document.getElementById('progressSection');
            progressSection.classList.remove('hidden');
            document.getElementById('resultDetails').classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/api/run_script`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        playlist_id: playlistId,
                        max_songs: maxSongs,
                        lastfm_username: lastfmUsername || null
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start discovery');
                }

                const data = await response.json();
                currentJobId = data.job_id;

                document.getElementById('statusMessage').textContent = 'Discovery started! Finding new music...';
                document.getElementById('progressFill').style.width = '30%';

                statusCheckInterval = setInterval(() => checkJobStatus(currentJobId), 2000);

            } catch (error) {
                console.error('Error starting discovery:', error);
                alert(error.message);

                startBtn.disabled = false;
                startBtn.textContent = 'Start Discovery';
                progressSection.classList.add('hidden');
            }
        }

        async function checkJobStatus(jobId) {
            try {
                const response = await fetch(`${API_URL}/api/job_status/${jobId}`, {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to get job status');
                }

                const job = await response.json();

                if (job.status === 'running') {
                    document.getElementById('statusMessage').textContent = 'Analyzing your music taste and finding new tracks...';
                    document.getElementById('progressFill').style.width = '60%';
                } else if (job.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;

                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('statusMessage').textContent = 'Discovery completed!';

                    if (job.result) {
                        showResults(job.result);
                    }

                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Discovery';

                } else if (job.status === 'failed') {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;

                    alert(job.error || 'Discovery failed. Please try again.');

                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Discovery';

                    document.getElementById('progressSection').classList.add('hidden');
                }

            } catch (error) {
                console.error('Error checking job status:', error);
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
                alert('Lost connection to server. Please refresh and try again.');
            }
        }

        function showResults(result) {
            const resultDetails = document.getElementById('resultDetails');
            resultDetails.classList.remove('hidden');

            let html = '<h4>‚ú® Discovery Complete!</h4><ul>';

            if (result.tracks_added !== undefined) {
                html += `<li>Added ${result.tracks_added} new tracks</li>`;
            }

            if (result.tracks_removed !== undefined) {
                html += `<li>Removed ${result.tracks_removed} old tracks (7+ days)</li>`;
            }

            if (result.message) {
                html += `<li>${result.message}</li>`;
            }

            html += '</ul>';
            resultDetails.innerHTML = html;
        }
    </script>
</body>

</html>