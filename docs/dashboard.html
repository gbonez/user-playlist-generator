<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Discovery - Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="dashboard-page">
            <div class="header"
                style="position: sticky; top: 0; z-index: 100; background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h2 id="userName" style="margin: 0; cursor: pointer; font-size: 1.25rem;">Welcome!</h2>
                <div class="profile-dropdown" style="position: relative;">
                    <img id="userAvatar" src="" alt="Profile" onclick="toggleProfileMenu()"
                        style="width: 48px; height: 48px; border-radius: 50%; cursor: pointer; border: 2px solid #1db954; object-fit: cover;">
                    <div id="profileMenu" class="profile-menu"
                        style="display: none; position: absolute; top: 60px; right: 0; background: #282828; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; min-width: 180px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                        <a href="database_modifier.html"
                            style="display: block; width: 100%; padding: 12px 16px; background: none; border: none; color: white; text-align: left; cursor: pointer; font-size: 0.95rem; transition: background 0.2s; text-decoration: none;"
                            onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                            onmouseout="this.style.background='none'">
                            üóÑÔ∏è Database Modifier
                        </a>
                        <button onclick="logout()"
                            style="width: 100%; padding: 12px 16px; background: none; border: none; color: white; text-align: left; cursor: pointer; font-size: 0.95rem; transition: background 0.2s; border-top: 1px solid rgba(255, 255, 255, 0.1);"
                            onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                            onmouseout="this.style.background='none'">
                            Log out
                        </button>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <h1>Discover New Music</h1>
                <p class="subtitle">Add fresh tracks to your playlist automatically</p>

                <div class="form-card">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="createNewPlaylist" onchange="togglePlaylistSelect()"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Create new playlist?</span>
                        </label>
                    </div>

                    <div class="form-group" id="playlistSelectGroup">
                        <label for="playlistSelect">Select playlist to add songs to</label>
                        <select id="playlistSelect" class="input">
                            <option value="">Loading playlists...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="generationMode">Generation Mode</label>
                        <select id="generationMode" class="input" onchange="toggleSourceUrlInput()">
                            <option value="liked_songs">Based on Liked Songs</option>
                            <option value="track">Based on Single Track</option>
                            <option value="artist">Based on Artist</option>
                            <option value="album">Based on Album</option>
                            <option value="playlist">Based on Playlist</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="sourceUrlGroup">
                        <label for="sourceUrl">Spotify URL</label>
                        <input type="text" id="sourceUrl" class="input"
                            placeholder="Paste Spotify track/artist/playlist URL">
                        <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); margin-top: 4px;">
                            Example: https://open.spotify.com/track/...
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="maxSongs">Number of Songs (1-50)</label>
                        <input type="number" id="maxSongs" class="input" min="1" max="50" value="10">
                    </div>

                    <div class="form-group hidden" id="minLikedSongsGroup">
                        <label for="minLikedSongs">Minimum Liked Songs per Artist: <span
                                id="minLikedSongsText">3</span></label>
                        <input type="range" id="minLikedSongs" min="1" max="20" value="3"
                            oninput="updateMinLikedSongsText(this.value)"
                            style="width: 100%; height: 8px; border-radius: 4px; background: linear-gradient(to right, #1db954, #9333ea); cursor: pointer; -webkit-appearance: none; appearance: none;">
                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); margin-top: 4px;">
                            <span>Diverse (1)</span>
                            <span>Focused (20)</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="nicheLevel">Artist Discovery Level: <span
                                id="nicheLevelText">Balanced</span></label>
                        <input type="range" id="nicheLevel" min="1" max="5" value="3"
                            oninput="updateNicheLevelText(this.value)"
                            style="width: 100%; height: 8px; border-radius: 4px; background: linear-gradient(to right, #1db954, #9333ea); cursor: pointer; -webkit-appearance: none; appearance: none;">
                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); margin-top: 4px;">
                            <span>Popular</span>
                            <span>Niche</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="lastfmUsername">Last.fm Username (Optional)</label>
                        <input type="text" id="lastfmUsername" class="input" placeholder="Your Last.fm username">
                    </div>

                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="enableGenreMatching"
                            style="width: auto; height: 20px; cursor: pointer;">
                        <label for="enableGenreMatching" style="margin: 0; cursor: pointer;">
                            Strict Genre Matching
                            <span
                                style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); display: block; margin-top: 4px; font-style: italic;">
                                Enable for stricter genre requirements for track generation.
                            </span>
                        </label>
                    </div>

                    <div class="form-group hidden" id="excludeLikedSongsGroup"
                        style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="excludeLikedSongs"
                            style="width: auto; height: 20px; cursor: pointer;">
                        <label for="excludeLikedSongs" style="margin: 0; cursor: pointer;">
                            Exclude Liked Songs
                            <span
                                style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); display: block; margin-top: 4px; font-style: italic;">
                                Excludes liked songs from recommendation generation.
                            </span>
                        </label>
                    </div>

                    <button onclick="startDiscovery()" id="startBtn" class="btn-primary">
                        Start Discovery
                    </button>
                </div>

                <div id="progressSection" class="progress-section hidden">
                    <h3>Discovery in Progress...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="statusMessage" class="status-message">Starting...</p>
                    <div id="resultDetails" class="result-details hidden"></div>
                </div>

                <div id="addedSongsSection" class="added-songs-section hidden">
                    <h3>Added Songs ‚ú®</h3>
                    <div id="addedSongsList" class="added-songs-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use localhost for local testing, Railway for production
        // Backend API URL - using Railway-provided domain
        const API_URL = 'https://user-playlist-generator-production.up.railway.app';

        console.log('Using API URL:', API_URL);
        let currentJobId = null;
        let statusCheckInterval = null;
        let accessToken = null;

        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üéØ DASHBOARD LOADED');
            console.log('üìç Current URL:', window.location.href);

            try {
                // Check for token in localStorage
                const tokenInfo = localStorage.getItem('spotify_token_info');
                console.log('üíæ Token from localStorage:', tokenInfo ? 'EXISTS' : 'NULL');

                if (!tokenInfo) {
                    console.log('‚ùå No token found, redirecting to login');
                    const loginUrl = `${window.location.origin}/user-playlist-generator/login.html`;
                    console.log('üîó AUTHENTICATION URL FOR DB SCRIPT:');
                    console.log(loginUrl);
                    console.log('üìã Copy this URL to use in your db creation script');
                    window.location.href = '/user-playlist-generator/login.html';
                    return;
                }

                const token = JSON.parse(tokenInfo);
                accessToken = token.access_token;
                console.log('üîë Access token parsed:', accessToken ? accessToken.substring(0, 20) + '...' : 'NULL');

                // Check if token is expired
                const now = Date.now() / 1000;
                console.log('‚è∞ Token expires at:', token.expires_at, '| Current time:', now);

                if (token.expires_at && now > token.expires_at) {
                    console.log('‚ùå Token expired, redirecting to login');
                    localStorage.removeItem('spotify_token_info');
                    const loginUrl = `${window.location.origin}/user-playlist-generator/login.html`;
                    console.log('üîó AUTHENTICATION URL FOR DB SCRIPT:');
                    console.log(loginUrl);
                    console.log('üìã Copy this URL to use in your db creation script');
                    window.location.href = '/user-playlist-generator/login.html';
                    return;
                }

                console.log('‚úÖ Token found and valid, loading user info from Spotify...');

                // Fetch user info from Spotify API
                const userResponse = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                console.log('üë§ User info response status:', userResponse.status);

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    console.log('‚úÖ User info loaded:', userData.display_name);
                    document.getElementById('userName').textContent = `Welcome, ${userData.display_name}!`;

                    // Set profile picture
                    const userAvatar = document.getElementById('userAvatar');
                    if (userData.images && userData.images.length > 0) {
                        userAvatar.src = userData.images[0].url;
                    } else {
                        // Fallback to default avatar
                        userAvatar.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231db954"><circle cx="12" cy="12" r="10"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="white"/></svg>';
                    }

                    // Store user ID for creating playlists
                    window.spotifyUserId = userData.id;

                    loadPlaylists();

                    // Initialize UI state for generation mode
                    toggleSourceUrlInput();
                } else {
                    console.error('‚ùå Failed to fetch user info, status:', userResponse.status);
                    const errorText = await userResponse.text();
                    console.error('‚ùå Error response:', errorText);
                    localStorage.removeItem('spotify_token_info');
                    const loginUrl = `${window.location.origin}/user-playlist-generator/login.html`;
                    console.log('üîó AUTHENTICATION URL FOR DB SCRIPT:');
                    console.log(loginUrl);
                    console.log('üìã Copy this URL to use in your db creation script');
                    window.location.href = '/user-playlist-generator/login.html';
                }
            } catch (error) {
                console.error('‚ùå Auth check error:', error);
                console.error('‚ùå Error stack:', error.stack);
                localStorage.removeItem('spotify_token_info');
                const loginUrl = `${window.location.origin}/user-playlist-generator/login.html`;
                console.log('üîó AUTHENTICATION URL FOR DB SCRIPT:');
                console.log(loginUrl);
                console.log('üìã Copy this URL to use in your db creation script');
                window.location.href = '/user-playlist-generator/login.html';
            }
        });

        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close profile menu when clicking outside
        document.addEventListener('click', (event) => {
            const profileDropdown = document.querySelector('.profile-dropdown');
            const menu = document.getElementById('profileMenu');
            if (menu && !profileDropdown.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        function togglePlaylistSelect() {
            const createNew = document.getElementById('createNewPlaylist').checked;
            const playlistGroup = document.getElementById('playlistSelectGroup');
            playlistGroup.style.display = createNew ? 'none' : 'block';
        }

        function toggleSourceUrlInput() {
            const mode = document.getElementById('generationMode').value;
            const urlGroup = document.getElementById('sourceUrlGroup');
            const minLikedSongsGroup = document.getElementById('minLikedSongsGroup');
            const excludeLikedSongsGroup = document.getElementById('excludeLikedSongsGroup');

            if (mode === 'liked_songs') {
                urlGroup.classList.add('hidden');
                minLikedSongsGroup.classList.remove('hidden');
                excludeLikedSongsGroup.classList.add('hidden');
            } else {
                urlGroup.classList.remove('hidden');
                minLikedSongsGroup.classList.add('hidden');
                excludeLikedSongsGroup.classList.remove('hidden');
            }
        }

        function updateMinLikedSongsText(value) {
            document.getElementById('minLikedSongsText').textContent = value;
        }

        function updateNicheLevelText(value) {
            const labels = {
                '1': 'Popular',
                '2': 'Very Popular',
                '3': 'Balanced',
                '4': 'Somewhat Niche',
                '5': 'Niche'
            };
            document.getElementById('nicheLevelText').textContent = labels[value];
        }

        function getNicheFollowerCount(level) {
            // Level 1 (Popular): No limit
            // Level 2 (Very Popular): 3,000,000 followers
            // Level 3 (Balanced): 1,000,000 followers
            // Level 4 (Somewhat Niche): 100,000 followers
            // Level 5 (Niche): 25,000 followers
            const followerLimits = {
                '1': null,
                '2': 3000000,
                '3': 1000000,
                '4': 100000,
                '5': 25000
            };
            return followerLimits[level];
        }

        async function logout() {
            // Clear token from localStorage
            localStorage.removeItem('spotify_token_info');

            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            console.log('‚úÖ Logged out');
            window.location.href = '/user-playlist-generator/login.html';
        }

        async function loadPlaylists() {
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Loading playlists...</option>';

            try {
                // Fetch playlists from Spotify API directly using token
                const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load playlists');
                }

                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    select.innerHTML = '<option value="">Select a playlist...</option>';

                    data.items.forEach(playlist => {
                        const option = document.createElement('option');
                        option.value = playlist.id;
                        option.textContent = `${playlist.name} (${playlist.tracks.total} tracks)${playlist.owner.id === playlist.owner.id ? '' : ' - Collaborative'}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No playlists found</option>';
                }
            } catch (error) {
                console.error('Error loading playlists:', error);
                select.innerHTML = '<option value="">Error loading playlists</option>';
            }
        }

        async function startDiscovery() {
            const createNew = document.getElementById('createNewPlaylist').checked;
            let playlistId = document.getElementById('playlistSelect').value;
            const maxSongs = parseInt(document.getElementById('maxSongs').value);
            const lastfmUsername = document.getElementById('lastfmUsername').value.trim();
            const nicheLevel = document.getElementById('nicheLevel').value;
            const maxFollowers = getNicheFollowerCount(nicheLevel);
            const minLikedSongs = parseInt(document.getElementById('minLikedSongs').value);
            const generationMode = document.getElementById('generationMode').value;
            const sourceUrl = document.getElementById('sourceUrl').value.trim();
            const enableGenreMatching = document.getElementById('enableGenreMatching').checked;
            const excludeLikedSongs = document.getElementById('excludeLikedSongs').checked;

            // Hide previous results
            document.getElementById('addedSongsSection').classList.add('hidden');
            document.getElementById('resultDetails').classList.add('hidden');

            if (maxSongs < 1 || maxSongs > 50) {
                alert('Number of songs must be between 1 and 50');
                return;
            }

            // Validate source URL if not using liked songs
            if (generationMode !== 'liked_songs' && !sourceUrl) {
                alert('Please enter a Spotify URL for the selected generation mode');
                return;
            }

            // If creating new playlist, pass null as playlist_id and set create_new flag
            if (createNew) {
                playlistId = null;
            } else if (!playlistId) {
                alert('Please select a playlist or check "Create new playlist?"');
                return;
            }

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';

            const progressSection = document.getElementById('progressSection');
            progressSection.classList.remove('hidden');
            document.getElementById('resultDetails').classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/api/run_script`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        playlist_id: playlistId,
                        max_songs: maxSongs,
                        lastfm_username: lastfmUsername || null,
                        max_follower_count: maxFollowers,
                        create_new: createNew,
                        min_liked_songs: minLikedSongs,
                        generation_mode: generationMode,
                        source_url: sourceUrl || null,
                        enable_genre_matching: enableGenreMatching,
                        exclude_liked_songs: excludeLikedSongs
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to start discovery');
                }

                const data = await response.json();
                currentJobId = data.job_id;

                document.getElementById('statusMessage').textContent = 'Your playlist will be generated soon! Discovering tracks...';
                document.getElementById('progressFill').style.width = '50%';

                statusCheckInterval = setInterval(() => checkJobStatus(currentJobId), 2000);

            } catch (error) {
                console.error('Error starting discovery:', error);
                alert(error.message);

                startBtn.disabled = false;
                startBtn.textContent = 'Start Discovery';
                progressSection.classList.add('hidden');
            }
        }

        async function checkJobStatus(jobId) {
            try {
                const response = await fetch(`${API_URL}/api/job_status/${jobId}`, {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to get job status');
                }

                const job = await response.json();

                if (job.status === 'starting' || job.status === 'running') {
                    // Update status message dynamically
                    let statusMsg = job.status_message || 'Analyzing your music taste and finding new tracks...';
                    document.getElementById('statusMessage').textContent = statusMsg;

                    // Calculate dynamic progress based on tracks processed
                    let progressPercent = 60; // Default
                    if (job.progress !== undefined) {
                        progressPercent = Math.min(95, 10 + (job.progress * 85)); // 10% start, up to 95%
                    }
                    document.getElementById('progressFill').style.width = `${progressPercent}%`;
                } else if (job.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;

                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('statusMessage').textContent = 'Discovery completed!';

                    if (job.result) {
                        showResults(job.result);
                    }

                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Discovery';

                } else if (job.status === 'failed') {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;

                    alert(job.error || 'Discovery failed. Please try again.');

                    const startBtn = document.getElementById('startBtn');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Discovery';

                    document.getElementById('progressSection').classList.add('hidden');
                }

            } catch (error) {
                console.error('Error checking job status:', error);
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
                alert('Lost connection to server. Please refresh and try again.');
            }
        }

        function showResults(result) {
            const resultDetails = document.getElementById('resultDetails');
            resultDetails.classList.remove('hidden');

            let html = '<h4>‚ú® Discovery Complete!</h4><ul>';

            if (result.tracks_added !== undefined) {
                html += `<li>Added ${result.tracks_added} new tracks</li>`;
            }

            if (result.tracks_removed !== undefined) {
                html += `<li>Removed ${result.tracks_removed} old tracks (7+ days)</li>`;
            }

            if (result.message) {
                html += `<li>${result.message}</li>`;
            }

            // Display added songs if available
            if (result.added_songs && result.added_songs.length > 0) {
                const addedSongsSection = document.getElementById('addedSongsSection');
                const addedSongsList = document.getElementById('addedSongsList');

                addedSongsSection.classList.remove('hidden');

                let songsHtml = '';
                result.added_songs.forEach((song, index) => {
                    // Format genres if they exist
                    let genresHtml = '';
                    if (song.genres && song.genres.length > 0) {
                        const genreTags = song.genres.map(genre =>
                            `<span style="display: inline-block; padding: 2px 8px; background: rgba(29, 185, 84, 0.2); color: #1db954; border-radius: 12px; font-size: 0.75rem; margin-right: 4px; margin-top: 4px;">${genre}</span>`
                        ).join('');
                        genresHtml = `<div style="margin-top: 6px;">${genreTags}</div>`;
                    }

                    songsHtml += `
                        <div class="song-item" style="padding: 12px; margin: 8px 0; background: rgba(255, 255, 255, 0.05); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1rem; margin-bottom: 4px;">
                                    ${index + 1}. ${song.title}
                                </div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                                    ${song.artist}
                                </div>
                                ${song.based_on_artist ? `<div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem; margin-top: 4px;">Based on: ${song.based_on_artist}</div>` : ''}
                                ${genresHtml}
                            </div>
                            <a href="${song.spotify_url}" target="_blank" style="padding: 8px 16px; background: #1db954; color: white; text-decoration: none; border-radius: 20px; font-size: 0.85rem; font-weight: 600; transition: background 0.2s; white-space: nowrap;" onmouseover="this.style.background='#1ed760'" onmouseout="this.style.background='#1db954'">
                                Open in Spotify
                            </a>
                        </div>
                    `;
                });

                addedSongsList.innerHTML = songsHtml;
            }

            html += '</ul>';
            resultDetails.innerHTML = html;
        }
    </script>
</body>

</html>